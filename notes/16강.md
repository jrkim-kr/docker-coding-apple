# 16. Orchestration 3. 서비스 만들기

# 핵심 정리

## 🎯 학습 목표

이 튜토리얼을 마치면 다음을 할 수 있습니다:

- AWS ECS에서 서비스를 생성하고 관리하기
- 컴퓨팅 옵션(Fargate/EC2) 이해하고 선택하기
- 로드 밸런서를 통해 트래픽 분산하기
- VPC와 네트워킹 기본 개념 파악하기
- 보안 그룹으로 접근 제어하기

---

## 📚 사전 지식

- Docker 기본 명령어와 컨테이너 개념
- AWS 계정 및 기본적인 AWS 콘솔 사용법
- 태스크 정의(Task Definition) 생성 경험
- 네트워크와 포트의 기본 개념

---

## 1단계: ECS 서비스란?

### 서비스 vs 태스크

- \*태스크(Task)\*\*는 실제로 실행되는 컨테이너입니다.
- Docker로 비유하면 `docker run`으로 실행한 컨테이너 하나
- \*서비스(Service)\*\*는 태스크들을 관리하는 상위 개념입니다.
- 태스크를 몇 개 실행할지
- 태스크가 죽으면 자동으로 재시작할지
- 업데이트는 어떻게 할지

```
[서비스]
   ├─ [태스크 1] → 컨테이너 실행 중
   ├─ [태스크 2] → 컨테이너 실행 중
   └─ [태스크 3] → 컨테이너 실행 중

```

### 왜 서비스를 사용하나요?

- ✅ **자동 복구**: 태스크가 죽으면 자동으로 다시 시작
- ✅ **스케일링**: 트래픽에 따라 태스크 개수 자동 조절
- ✅ **로드 밸런싱**: 여러 태스크에 트래픽 균등 분배
- ✅ **무중단 배포**: 새 버전으로 안전하게 업데이트

---

## 2단계: 컴퓨팅 옵션 선택

### 시작 유형 이해하기

AWS ECS에서 컨테이너를 실행할 때, **어떤 컴퓨터에서** 실행할지 정해야 합니다.

**선택지:**

1. **시작 유형 (Launch Type)**: 한 가지 컴퓨팅 방식만 사용
2. **용량 공급자 전략 (Capacity Provider)**: 여러 방식을 섞어서 사용

### Fargate vs EC2

| 구분       | Fargate               | EC2                          |
| ---------- | --------------------- | ---------------------------- |
| **관리**   | AWS가 서버 관리       | 직접 서버 관리 필요          |
| **비용**   | 사용한 만큼만 과금    | 서버 켜둔 시간만큼 과금      |
| **설정**   | 간단함                | 복잡함                       |
| **유연성** | 제한적                | 매우 높음                    |
| **추천**   | 초보자, 간단한 서비스 | 고급 사용자, 복잡한 요구사항 |

**비유로 이해하기:**

- **Fargate**: 택시 타기 (필요할 때만 타고, 관리 필요 없음)
- **EC2**: 자동차 사기 (관리는 직접, 자유도 높음)

```bash
# 실습: 시작 유형으로 Fargate 선택

```

**참고: 스팟 인스턴스**

- 남는 컴퓨팅 자원을 70% 저렴하게 빌려 쓰는 것
- 단점: 원래 주인이 회수하면 갑자기 종료될 수 있음
- 용도: 1회성 작업, 중단되어도 괜찮은 작업

---

## 3단계: 배포 구성

### 태스크 정의 선택

이전에 만들어둔 **태스크 정의 파일**을 선택합니다.

- 태스크 정의 = Docker Compose 파일이라고 생각하면 됨
- 어떤 이미지를 사용할지, 어떤 설정을 적용할지 정의된 파일

```
예: my-task-definition (개정: 2)
     ↓
이 파일에 따라 컨테이너 실행

```

### 태스크 개수 설정

**원하는 작업 수**: 동시에 실행할 태스크 개수

```
원하는 작업 수: 3
   ↓
3개의 동일한 컨테이너 실행

```

**장점:**

- 트래픽 분산 가능
- 하나가 죽어도 나머지가 서비스 지속

### 가용영역 리밸런싱

여러 태스크를 **다른 지역(AZ)**에 분산 배치하는 기능

```
서울 리전          도쿄 리전         오사카 리전
[태스크 1]        [태스크 2]        [태스크 3]

```

**장점:**

- 한 지역에 문제가 생겨도 다른 지역에서 서비스 지속
- 재해 복구(Disaster Recovery)에 유리

**초보자는**: 체크 해제 (비용 절감)

---

## 4단계: 배포 옵션

컨테이너를 업데이트할 때 **어떤 방식**으로 할지 선택합니다.

### 롤링 업데이트

**기존 태스크를 하나씩 교체**하는 방식

```
[단계 1] 기존:  🔵 🔵 🔵
         새버전: 🟢 (추가 시작)

[단계 2] 기존:  🔵 🔵 ❌ (하나 종료)
         새버전: 🟢

[단계 3] 기존:  🔵 ❌ ❌
         새버전: 🟢 🟢

[단계 4] 기존:  ❌ ❌ ❌
         새버전: 🟢 🟢 🟢 (완료)

```

**최댓값 설정:**

- 최댓값 200% = 기존 3개 + 새 3개 = 총 6개까지 동시 실행 가능

**장점:**

- 간단하고 안전함
- 서비스 중단 없음

**단점:**

- 사용자가 구버전/신버전 혼용 경험 가능
- 업데이트 시간이 다소 길 수 있음

### 블루그린 배포

**새 버전을 완전히 준비한 후 한 번에 교체**하는 방식

```
[파란색 환경] 🔵 🔵 🔵 (기존 버전)
              ↑
         모든 트래픽

[준비 단계]
[파란색] 🔵 🔵 🔵 (기존)
[초록색] 🟢 🟢 🟢 (신규 - 준비 중)

[전환 단계]
[파란색] 🔵 🔵 🔵 (대기)
         ↓
[초록색] 🟢 🟢 🟢 (신규)
         ↑
    모든 트래픽 (전환 완료!)

```

**장점:**

- 한 번에 모든 사용자가 새 버전 사용
- 문제 생기면 빠르게 롤백 가능

**단점:**

- 두 배의 리소스 필요 (비용 증가)
- 설정이 복잡함

**선택 가이드:**

- 간단한 업데이트 → 롤링 업데이트
- 중요한 변경사항 → 블루그린

---

## 5단계: Service Connect

여러 서비스가 있을 때, **서비스끼리 통신**할 수 있게 이름을 지어주는 기능입니다.

```
[서비스 A: 프론트엔드]
        ↓ 요청
[서비스 B: 백엔드] ← 이름이 있어야 찾을 수 있음!

```

**옵션:**

1. **클라이언트**: 다른 서비스에만 연결 (요청만 보냄)
2. **클라이언트 및 서버**: 다른 서비스도 나를 찾을 수 있음 (양방향)

**지금은**: 나중에 필요할 때 설정 (일단 넘어가기)

---

## 6단계: 네트워킹 설정

### VPC란?

**VPC (Virtual Private Cloud)** = 가상 네트워크

AWS 클라우드 안에 **내 전용 네트워크 공간**을 만드는 것입니다.

```
[AWS 클라우드]
  └─ [내 VPC]
       ├─ 서비스들
       ├─ 컴퓨터들
       └─ 데이터베이스들

```

**비유:**

- VPC = 아파트 단지
- Subnet = 동별 구분
- 보안 그룹 = 출입 통제 시스템

### Subnet 이해하기

**Subnet** = VPC 안에서 서비스를 보관하는 폴더 같은 것

```
[VPC - 아파트 단지]
  ├─ [Public Subnet - 101동]
  │    ├─ 로드 밸런서 (외부 접근 가능)
  │    └─ 웹 서버
  │
  └─ [Private Subnet - 102동]
       ├─ 데이터베이스 (외부 접근 불가)
       └─ 내부 API 서버

```

**Public Subnet**: 인터넷에서 접근 가능
**Private Subnet**: 내부에서만 접근 가능

**Docker와 비교:**

- Docker Network와 비슷한 개념
- 같은 Subnet 안의 컴퓨터들은 쉽게 통신 가능

### Public IP 할당

**퍼블릭 IP 주소** = 인터넷에서 접근 가능한 주소

```
✅ 퍼블릭 IP 있음
[태스크] ← 외부와 통신 가능
   ↕️
인터넷 (Docker Hub에서 이미지 다운로드 가능)

❌ 퍼블릭 IP 없음
[태스크] ← 외부와 통신 불가
   X
인터넷

```

**Fargate 사용 시:**

- 반드시 체크! (안 하면 이미지 다운로드 안 됨)

**⚠️ 주의사항:**

- 퍼블릭 IPv4 주소는 월 $4 정도 비용 발생
- AWS의 최근 정책 변경으로 IPv4 주소 사용 시 과금

**무료 대안:**

- IPv6 사용 (하지만 AWS에서 지원이 제한적)
- ECR(AWS의 Docker 이미지 저장소) + VPC 엔드포인트 사용

---

## 7단계: 로드 밸런서 설정

### 로드 밸런서가 필요한 이유

**로드 밸런서** = 들어오는 트래픽을 여러 태스크에 **균등하게 분배**하는 프로그램

```
[사용자들]
   ↓ ↓ ↓
[로드 밸런서] ← 단일 진입점
   ↓ ↓ ↓
[태스크1] [태스크2] [태스크3]

```

**필요한 이유:**

1. **Fargate의 경우**: 실제 서버가 없어서 외부에서 접속하려면 필수
2. **트래픽 분산**: 여러 태스크에 고르게 요청 분배
3. **헬스 체크**: 죽은 태스크로는 트래픽 보내지 않음
4. **고정 주소**: 태스크 IP가 바뀌어도 로드 밸런서 주소는 고정

**비유:**

- 로드 밸런서 = 호텔 프런트 데스크
- 태스크들 = 각 객실
- 손님(사용자)은 프런트로만 가면 빈 방(태스크)으로 안내받음

### Application Load Balancer 생성

```
[Application Load Balancer 설정]

1. 리스너 포트: 80 (HTTP)
   └─ 어떤 포트로 트래픽을 받을지

2. 대상 그룹: 자동 생성
   └─ 트래픽을 어디로 보낼지 (우리 서비스로!)

3. 프로토콜: HTTP
   └─ 나중에 HTTPS 추가 가능

```

**비용:** 로드 밸런서는 별도 요금 발생 (시간당 과금)

**대안:**

- Nginx를 직접 설치한 EC2 사용
- Traefik 같은 클라우드 친화적 도구 사용

---

## 8단계: 보안 그룹 설정

### 보안 그룹이란?

**보안 그룹 (Security Group)** = 방화벽 규칙

**누가 내 서비스에 접속할 수 있는지** 정의합니다.

```
[인터넷의 누군가]
        ↓
   [보안 그룹]  ← 허용/차단 결정
        ↓
   [내 서비스]

```

**비유:**

- 보안 그룹 = 아파트 경비실
- 규칙 = 방문자 명단
- 허용된 사람만 출입 가능

### 규칙 설정하기

**이상적인 구조:**

```
[로드 밸런서 보안 그룹]
규칙: 모든 IP에서 80번 포트 접속 허용
      ↓
[서비스 보안 그룹]
규칙: 로드 밸런서에서만 접속 허용

```

**VPC 메뉴에서 설정:**

```
유형: 사용자 지정 TCP
포트: 80
소스: 0.0.0.0/0 (모든 IP 허용)

```

**설명:**

- `0.0.0.0/0` = 전 세계 모든 IP 주소
- 80번 포트 = HTTP 기본 포트

**⚠️ 주의:**
로드 밸런서를 서비스와 함께 만들면 보안 그룹이 합쳐집니다.
더 안전하게 하려면 로드 밸런서를 별도로 만들어 각각 보안 그룹 설정하세요.

---

## 9단계: 서비스 생성 및 확인

### 생성 진행

1. **서비스 생성** 버튼 클릭
2. 로드 밸런서 생성 때문에 **5분 이상** 소요
3. 기다리면 서비스 생성 완료!

### 상태 확인

**서비스 페이지:**

```
서비스 상태: 활성
실행 중인 태스크: 3/3

```

**태스크 상태:**

- 🟢 **실행 중**: 정상 작동
- 🔵 **대기 중** (5분 이상): 문제 발생!

### 접속 테스트

1. **로드 밸런서 찾기**
   - EC2 → 로드 밸런서 메뉴
   - DNS 이름 복사
2. **브라우저 접속**

   ```
   http://로드밸런서DNS주소

   ```

3. **성공!**
   - Nginx와 웹서버가 표시되면 성공

### 다음 단계

실제 서비스로 운영하려면:

- ✅ 도메인 구매 및 연결
- ✅ HTTPS 인증서 설치 (AWS Certificate Manager)
- ✅ Route 53으로 DNS 설정

---

## 🔧 문제 해결 가이드

### 문제 1: 태스크가 5분 이상 "대기 중"

**증상:**

```
태스크 상태: 대기 중 (파란색)

```

**원인 및 해결:**

1. **이미지 다운로드 실패**
   - 에러: `CannotPullContainerError`
   - 해결: Public IP 할당 체크 확인
   - 또는: ECR에 이미지 업로드 후 사용
2. **잘못된 이미지 설정**
   - 태스크 정의에서 이미지 경로 확인
   - 이미지가 실제로 존재하는지 확인
3. **로그 확인**
   - 태스크 → 로그 탭
   - CloudWatch 로그에서 에러 메시지 확인

### 문제 2: 서비스는 실행 중인데 접속 안 됨

**증상:**

```
태스크: 실행 중 (초록색)
브라우저: 연결 불가

```

**원인 및 해결:**

1. **보안 그룹 설정 누락**
   - 로드 밸런서 보안 그룹 확인
   - 80번 포트가 0.0.0.0/0에 열려있는지 확인
2. **대상 그룹 설정 오류**
   - EC2 → 대상 그룹
   - 등록된 대상이 healthy 상태인지 확인
3. **Nginx 설정 오류**
   - 태스크 정의의 Nginx 설정 파일 확인
   - 로그에서 Nginx 에러 확인

### 문제 3: 비용이 예상보다 많이 나옴

**확인 사항:**

1. **실행 중인 리소스**
   - 서비스 (Fargate 작업 시간)
   - 로드 밸런서 (시간당)
   - Elastic IP (사용 중인 퍼블릭 IP)
   - NAT Gateway (사용 시)
2. **로그 확인**
   - EC2 → 로드 밸런서 (삭제 확인)
   - VPC → Elastic IP (릴리스 확인)
   - ECS → 서비스 (삭제 확인)

---

## 💰 비용 관리

### 리소스 정리 체크리스트

실습 후 반드시 삭제해야 할 것들:

```
✅ 1. ECS 서비스 삭제
   - ECS → 클러스터 → 서비스 → 삭제

✅ 2. 로드 밸런서 삭제
   - EC2 → 로드 밸런서 → 삭제
   - 대상 그룹도 함께 삭제됨

✅ 3. Elastic IP 릴리스
   - EC2 → Elastic IP → 릴리스
   - 안 쓰는 IP도 비용 발생!

✅ 4. NAT Gateway 삭제 (사용 시)
   - VPC → NAT Gateway → 삭제

✅ 5. CloudWatch 로그 (선택)
   - 로그 그룹 삭제 (무료 한도 초과 시)

```

**Fargate 클러스터:**

- 비어있으면 비용 없음
- 삭제해도 되고 안 해도 됨

### 예상 비용

**월간 비용 예시 (서울 리전):**

```
Fargate 작업 (1 vCPU, 2GB)
 - 시간당 약 $0.05
 - 하루 종일: $1.2
 - 한 달: $36

로드 밸런서
 - 시간당 $0.025
 - 한 달: $18

퍼블릭 IPv4
 - 개당 월 $3.6

총계: 약 $57/월 (1개 태스크 기준)

```

---

## 🎓 핵심 요약

### 주요 개념

1. **서비스 = 태스크들의 관리자**
   - 자동 재시작, 스케일링, 로드 밸런싱
2. **Fargate vs EC2**
   - Fargate: 관리 간편, 초보자 추천
   - EC2: 유연함, 고급 사용자용
3. **배포 방식**
   - 롤링: 점진적 교체
   - 블루그린: 한 번에 전환
4. **네트워킹**
   - VPC: 가상 네트워크
   - Subnet: 서비스를 담는 폴더
   - 보안 그룹: 접근 제어 규칙
5. **로드 밸런서**
   - 트래픽 분산
   - Fargate 필수
   - 별도 비용 발생

### 실무 팁

**✅ DO (권장):**

- Public IP 할당 (Fargate 사용 시)
- 보안 그룹 최소 권한 원칙
- 로드 밸런서 헬스 체크 설정
- 로그 모니터링 설정
- 실습 후 리소스 정리

**❌ DON'T (비권장):**

- 보안 그룹에 불필요한 포트 열기
- Elastic IP 방치 (비용 발생)
- 프로덕션에서 스팟 인스턴스만 사용
- 로그 없이 운영
- 비용 알림 설정 안 함

### 다음 학습 방향

1. **자동 스케일링 설정**
   - CPU/메모리 기반 자동 확장
2. **CI/CD 파이프라인 구축**
   - GitHub Actions + ECS 자동 배포
3. **모니터링 강화**
   - CloudWatch Alarms
   - Container Insights
4. **HTTPS 적용**
   - ACM 인증서 발급
   - Route 53 도메인 연결
5. **비용 최적화**
   - Savings Plans
   - Spot 인스턴스 활용

---

## 📝 연습 문제

### 기초 문제

1. Fargate와 EC2의 가장 큰 차이점은?
2. 롤링 업데이트와 블루그린 배포의 장단점은?
3. Public Subnet과 Private Subnet의 차이는?

### 중급 문제

1. 태스크가 계속 "대기 중" 상태일 때 가장 먼저 확인해야 할 것은?
2. 보안 그룹에서 `0.0.0.0/0`의 의미는?
3. 로드 밸런서가 없어도 서비스를 운영할 수 있는 경우는?

### 실습 문제

1. 태스크 개수를 1개에서 3개로 늘려보세요
2. 새로운 버전의 이미지로 롤링 업데이트 해보세요
3. 보안 그룹을 수정하여 특정 IP만 접속 가능하게 해보세요

---

## 🔗 참고 자료

- [AWS ECS 공식 문서](https://docs.aws.amazon.com/ecs/)
- [Fargate 요금 계산기](https://aws.amazon.com/fargate/pricing/)
- [ECS 모범 사례](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/)
- [보안 그룹 규칙 설정 가이드](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)

---

**마지막 체크:** 실습을 마쳤다면 모든 리소스를 삭제했는지 꼭 확인하세요! 💸

---

# 강의 스크립트

**0:00 서비스 만들기**

**2:57 service connect**

**3:43 네트워킹**

**6:45 로드밸런서**

**10:33 생성된 서비스 구경**

저번 시간에 태스크 정의를 만들어봤는데 태스크 정의는 docker compose 파일이라고 했습니다.

그래서 그 파일이 있으면 서비스와 태스크를 띄울 수 있습니다.

클러스터 안에 들어가서 서비스 생성을 눌러봅시다.

> 서비스 시작유형

서비스 생성을 누르면 우선 컴퓨팅옵션을 정하라고 합니다.

이게 뭐냐면 어떤 컴퓨터에 태스크들을 띄울지 정하는 부분입니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%987.png)

- '용량공급자 전략' 이런거 고르면 EC2, Fargate에 태스크를 분산해서 띄울 수 있습니다.
- '시작 유형' 고르면 대충 한 곳에서 태스크를 띄워줍니다.

우리는 그냥 맨 처음에 Fargate하나만 쓴다고 해놨으니까 그냥 '시작 유형' 이런거 골라서 Fargate 쓴다고 합시다.

(참고) 스팟 인스턴스 이런건 뭐냐면 이건 남들이 안쓰는 EC2또는 Fargate 컴퓨터를 잠깐 빌려쓰는겁니다.

보통 70%더 저렴해서 좋은데 근데 원래 주인이 회수해가면 갑자기 컨테이너가 정지되고 그럴 위험성이 항상 있어서

1회성 작업같은거 할 때나 고려해봅시다.

> 배포구성

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%988.png)

▲ 여기는 서비스에 어떤 태스크를 실행할지 태스크 정의 파일을 고르는 부분입니다.

만들어둔 태스크 정의 파일을 골라줍시다.

'개정'은 태스크 정의 파일의 버전입니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%989.png)

▲ 서비스 안에 태스크를 몇개 복제해둘건지 선택도 가능합니다.

**가용영역 리밸런싱**은 태스크가 여러개 있는 경우

태스크를 서울 뿐만 아니라 오사카, 도쿄 등 가까운 리전(AZ)에 골고루 뿌려두는 짓입니다.

그럼 하나가 다운되어도 안정적으로 서비스가 가능한데 우리는 필요없겠군요.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9810.png)

▲ 배포옵션은 그냥 업데이트 옵션입니다.

나중에 태스크 내용이 업데이트가 되어야하면 기존 태스크를 끄고 새로 띄워야하지 않겠습니까

그래서 그 방법을 고르는 부분입니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/rolling2gif.gif)

▲ 롤링업데이트는

업데이트된 태스크들을 추가로 더 띄우고 그 다음에 기존 태스크를 차례로 종료시키는 방식입니다.

최댓값 설정도 가능한데 최댓값을 200%으로 설정한 경우에는

지금 3개 태스크가 실행중이면 3개를 또 띄워서 총 6개를 띄워둔 후에 옛날 컨테이너들을 하나씩 끄는 식으로 동작하라는 뜻입니다.

간편한데 유저들이 이전 태스크와 새로운 태스크로 골고루 안내되는 상황이 발생할 수 있습니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/bluegreen2gif.gif)

▲ 블루그린은

업데이트된 태스크들을 띄운 다음에 거기로 모든 트래픽을 갑자기 바꿔버리는 식으로 동작합니다.

그래서 한 번에 모든 트래픽을 새로운 컨테이너로 안내할 수 있는게 장점입니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9811.png)

▲ Service Connect라는 것도 설정도 할 수 있는데

서비스가 많아지면 서비스끼리 이름을 잘 지어놔야 서로 통신을 할 수 있어서 이름 지어주는 옵션입니다.

다른 서비스에 연결만 할거면 "클라이언트" 고르고

다른 서비스가 나를 찾는 상황도 필요하면 "서버" 뭐시기 고르면 됩니다.

나중에 필요하면 설정해봅시다.

> VPC

AWS에서 서비스할 때 항상 VPC 이런걸 고르라고 하는데 기본으로 선택되어있는거 일단 사용하면 됩니다.

VPC는 **가상 네트워크**입니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EA%B7%B8%EB%A6%BC7.png)

VPC 안에 subnet이라는걸 마음대로 만들어서 내 서비스나 컴퓨터를 보관하고 그럴 수 있습니다.

subnet은 그냥 폴더같은 것인데 비유하자면 도커에서 쓰던 네트워크랑 비슷한 개념입니다.

subnet 안에 있는 컴퓨터들은 서로 쉽게 통신이 가능합니다.

일반 사람들도 접속이 가능해야하면 public subnet을 만들어서 거기 넣어두고

일반 사람들이 접속하면 안되는 그런 컨테이너들은 private subnet 만들어서 거기 넣어두면 되고

나중에 어떤 subnet끼리 서로 통신할 수 있는지 제한도 해놓으면 안전하게 사용할 수 있는데

그건 **보안그룹**이라는걸 만지면 설정할 수 있습니다.

그래서 우리가 만드는 서비스가 속할 보안그룹도 새로 만들어주면 좋은데

이건 로드밸런서 만들고나서 조금 있다가 해봅시다.

> public IP 할당

태스크마다 퍼블릭 IP주소를 부여할지 선택해야하는데

퍼블릭 IP주소가 있으면 손쉽게 외부랑 통신이 가능합니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9812.png)

▲ 그래서 퍼블릭 IP가 있어야 외부에 올려둔 이미지도 받아올 수 있어서 퍼블릭 IP를 할당해줍시다.

이걸 안해두면 여러분이 직접 인터넷 게이트웨이 이런걸 귀찮게 설정해줘야 외부통신이 가능해지고 도커 이미지도 외부에서 받아올 수 있습니다.

그래서 Fargate 쓰면 일단 체크하고 갑시다.

근데 이거 체크하면 태스크마다 월 4달러인가 요금이 나올 수 있는데

왜냐면 AWS가 최근에 퍼블릭 IPv4 주소를 사용하면 하나 쓸 때마다 월 4달러인가 요금을 추가하기 시작했습니다.

그래서 그 대안으로 IPv6 주소는 무료니까 그거 쓰라고 하는데

AWS안에서 IPv6 주소는 쓸수 있는 곳이 거의 없습니다.

쓰레기같은 정책입니다.

이걸 체크 안할거면 도커 이미지를 AWS ECR이라는 곳에다가 올려서

VPC 엔드포인트 링크인가를 써서 가져오면 됩니다. 나중에 한번 해봅시다.

> load balancer 만들기

로드밸런서는 유저가 나에게 들어왔을 때

내 뒤에 있는 서버들에 균등하게 안내해주는 역할을 하는 프로그램일 뿐입니다.

이걸 왜 만드냐면

1. 일단 Fargate를 쓰면 컴퓨터 형체가 없습니다.

그래서 외부 사람들이 그 태스크 돌아가는 컴퓨터로 접속을 하려면 로드밸런서가 강제로 필요함

2. 태스크 여러개에다가 고르게 트래픽을 분산시키려면 로드밸런서가 필요함

그래서 지금처럼 외부인들이 접속해야되는 그런 서비스는 기본적으로 로드밸런서 하나 붙여주는게 낫습니다.

실은 컴퓨터 하나 빌려서 nginx로 직접 만들어도 되고

아니면 nginx대신 좀 더 클라우드환경에 적합한 Traefik같은 프로그램으로 만들어도 되고

근데 여기선 서비스 띄울 때 로드밸런서를 바로 만들고 장착할 수 있게 되어있어서 그렇게 만들어봅시다.

참고로 로드밸런서는 별도로 요금이 발생합니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9813.png)

▲ Application load balancer 만들면 됩니다.

어떤 컨테이너가 로드밸런서에서 오는 트래픽을 수신할지 정할 수 있습니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9815.png)

▲ 로드밸런서는 어떤 포트를 오픈할지도 정할 수 있습니다. 일단 80 넣어줍시다.

대상 그룹이 중요한데 로드밸런서로 들어오는 트래픽의 **목적지**를 정해주는 부분입니다.

그래서 "내가 지금 만드는 서비스"를 대상그룹으로 설정하면 되는데

근데 여기서 만들면 자동으로 채워지기 때문에 신경안쓰고 넘어가도 됩니다.

> 보안 그룹 (security group)

AWS에서 컴퓨터를 빌리거나 서비스를 만들거나 그럴 때

항상 보안그룹을 잘 설정해둬야 안전하게 운영이 가능합니다.

보안그룹은 누가 내 서비스나 컴퓨터에 접속할 수 있는지 정의해놓는 규칙입니다.

로드밸런서는 "인터넷상의 일반인 아무나 내 80번 포트로 접속가능"

서비스는 "로드밸런서만 접속가능"

이런 식으로 보안그룹을 각각 만들어두면 안전하겠죠?

근데 로드밸런서를 서비스랑 같이 만들어버리면 **보안그룹을 따로 만들 수 없고 합쳐서** 만들 수 밖에 없습니다.

그래서 안전하게 쓰려면 나중에 로드밸런서를 별도로 만들어와서 목적지를 서비스로 안내하고 그런 식으로 해보시고

지금은 그냥 위에 있는 보안그룹이나 설정하러 가봅시다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9816.png)

▲ VPC 메뉴에서 보안그룹을 만지면 서비스 + 로드밸런서의 보안그룹을 동시에 설정할 수 있습니다.

위 처럼 작성하면 80번 포트로 아무 아이피에서나 접속가능하다는 뜻입니다.

0.0.0.0/0 이게 아무 아이피라는 뜻임

그럼 앞으로 로드밸런서도메인주소:80 이걸 브라우저에 입력하면 개나소나 들어올 수 있게 됩니다.

일반 유저들도 들어올 수 있겠군요.

그럼 아무튼 서비스 생성을 눌러봅시다.

로드밸런서 때문에 5분 넘게 소요될텐데 아무튼 기다리면 서비스가 하나 생성이 되어있을겁니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/12/%EC%BA%A1%EC%B2%9817.png)

▲ 서비스로 들어가보면 어떤 태스크가 돌아가고 있는지 볼 수 있는데

태스크가 파란색으로 5분넘게 "대기중" 이라고 뜨면 뭔가 문제가 있다는 뜻입니다.

그럴 땐 로그, 태스크 이런 메뉴 들어가서 이상한 메세지는 없는지 확인해보면 됩니다.

내 서비스에 접속하려면 로드밸런서에 접속해보면 되는데

로드밸런서 찾아서 로드밸런서 DNS 주소를 가져와서 브라우저 주소창에 **http://로드밸런서DNS주소** 입력하면 됩니다.

그럼 서비스에서 돌아가고 있는 nginx와 웹서버 컨테이너를 잘 만날 수 있겠군요.

이제 로드밸런서에다가 HTTPS 인증서 설치하고 도메인 사서 연결하고 그러면 실제 웹서비스처럼 운영할 수 있겠군요.

> 서비스가 안떠요

- 5분동안 계속 대기중 상태를 못벗어나면 로그, 태스크 등 들어가서 에러메세지는 없는지 확인해봅시다.

이미지를 잘못 만들었거나, 이미지 다운로드를 못해왔거나, 보안그룹 설정이 이상하거나 그런 경우가 대부분임

- nginx에서 웹서버를 못찾는건 아닌가 nginx 설정파일을 확인해봅시다.
- CannotPullContainerError는 이미지 다운로드를 못했다는 뜻이라

서비스 생성시 네트워크 부분 설정에서 public IP 주소 할당을 켜봅시다.

- 초록불은 떠서 실행중이라고 뜨는데 http://로드밸런서DNS주소.com 으로 접속시 아무것도 안뜨면

로드밸런서의 "보안그룹" 들어가서 모든 아이피에서 80번 포트로 접속이 가능하도록 설정했나 확인합시다.

모든 아이피를 표현하고 싶으면 0.0.0.0입니다.

> 태스크 업데이트는

1. 코드짠걸 새로 빌드해서 이미지를 어딘가에 올리고

2. 기존에 있던 태스크 정의를 수정해서 어떤 이미지를 사용할건지 기재하고

3. 그 태스크로 기존 서비스 업데이트하라고 명령내리면 끝임

> 삭제는

서비스가 잘돌아가는거 확인했으면 요금나오니까 끕시다.

- 서비스 삭제하고
- 클러스터는 Fargate쓰는 경우 냅둬도 요금은 안나올텐데 불안하면 클러스터도 삭제하고
- 로드밸런서도 생성해놨을텐데 그것도 삭제하려면 상단에 EC2 검색해서 들어가서 로드밸런서 메뉴에서 삭제하면 됩니다.
- EC2 들어가면 Elastic IP 같은 것도 하나 있을 수 있는데 그것도 삭제해야 IP요금이 부과되지 않습니다.
