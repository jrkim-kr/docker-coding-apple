# 16. Orchestration 3. 서비스 만들기

# 핵심 정리

## 🎯 학습 목표

이 튜토리얼을 마치면 다음을 할 수 있습니다:

- AWS ECS에서 서비스를 생성하고 관리하기
- 컴퓨팅 옵션(Fargate/EC2) 이해하고 선택하기
- 로드 밸런서를 통해 트래픽 분산하기
- VPC와 네트워킹 기본 개념 파악하기
- 보안 그룹으로 접근 제어하기

---

## 📚 사전 지식

- Docker 기본 명령어와 컨테이너 개념
- AWS 계정 및 기본적인 AWS 콘솔 사용법
- 태스크 정의(Task Definition) 생성 경험
- 네트워크와 포트의 기본 개념

---

## 1단계: ECS 서비스란?

### 서비스 vs 태스크

- \*태스크(Task)\*\*는 실제로 실행되는 컨테이너입니다.
- Docker로 비유하면 `docker run`으로 실행한 컨테이너 하나
- \*서비스(Service)\*\*는 태스크들을 관리하는 상위 개념입니다.
- 태스크를 몇 개 실행할지
- 태스크가 죽으면 자동으로 재시작할지
- 업데이트는 어떻게 할지

```
[서비스]
   ├─ [태스크 1] → 컨테이너 실행 중
   ├─ [태스크 2] → 컨테이너 실행 중
   └─ [태스크 3] → 컨테이너 실행 중

```

### 왜 서비스를 사용하나요?

- ✅ **자동 복구**: 태스크가 죽으면 자동으로 다시 시작
- ✅ **스케일링**: 트래픽에 따라 태스크 개수 자동 조절
- ✅ **로드 밸런싱**: 여러 태스크에 트래픽 균등 분배
- ✅ **무중단 배포**: 새 버전으로 안전하게 업데이트

---

## 2단계: 컴퓨팅 옵션 선택

### 시작 유형 이해하기

AWS ECS에서 컨테이너를 실행할 때, **어떤 컴퓨터에서** 실행할지 정해야 합니다.

**선택지:**

1. **시작 유형 (Launch Type)**: 한 가지 컴퓨팅 방식만 사용
2. **용량 공급자 전략 (Capacity Provider)**: 여러 방식을 섞어서 사용

### Fargate vs EC2

| 구분       | Fargate               | EC2                          |
| ---------- | --------------------- | ---------------------------- |
| **관리**   | AWS가 서버 관리       | 직접 서버 관리 필요          |
| **비용**   | 사용한 만큼만 과금    | 서버 켜둔 시간만큼 과금      |
| **설정**   | 간단함                | 복잡함                       |
| **유연성** | 제한적                | 매우 높음                    |
| **추천**   | 초보자, 간단한 서비스 | 고급 사용자, 복잡한 요구사항 |

**비유로 이해하기:**

- **Fargate**: 택시 타기 (필요할 때만 타고, 관리 필요 없음)
- **EC2**: 자동차 사기 (관리는 직접, 자유도 높음)

```bash
# 실습: 시작 유형으로 Fargate 선택

```

**참고: 스팟 인스턴스**

- 남는 컴퓨팅 자원을 70% 저렴하게 빌려 쓰는 것
- 단점: 원래 주인이 회수하면 갑자기 종료될 수 있음
- 용도: 1회성 작업, 중단되어도 괜찮은 작업

---

## 3단계: 배포 구성

### 태스크 정의 선택

이전에 만들어둔 **태스크 정의 파일**을 선택합니다.

- 태스크 정의 = Docker Compose 파일이라고 생각하면 됨
- 어떤 이미지를 사용할지, 어떤 설정을 적용할지 정의된 파일

```
예: my-task-definition (개정: 2)
     ↓
이 파일에 따라 컨테이너 실행

```

### 태스크 개수 설정

**원하는 작업 수**: 동시에 실행할 태스크 개수

```
원하는 작업 수: 3
   ↓
3개의 동일한 컨테이너 실행

```

**장점:**

- 트래픽 분산 가능
- 하나가 죽어도 나머지가 서비스 지속

### 가용영역 리밸런싱

여러 태스크를 **다른 지역(AZ)**에 분산 배치하는 기능

```
서울 리전          도쿄 리전         오사카 리전
[태스크 1]        [태스크 2]        [태스크 3]

```

**장점:**

- 한 지역에 문제가 생겨도 다른 지역에서 서비스 지속
- 재해 복구(Disaster Recovery)에 유리

**초보자는**: 체크 해제 (비용 절감)

---

## 4단계: 배포 옵션

컨테이너를 업데이트할 때 **어떤 방식**으로 할지 선택합니다.

### 롤링 업데이트

**기존 태스크를 하나씩 교체**하는 방식

```
[단계 1] 기존:  🔵 🔵 🔵
         새버전: 🟢 (추가 시작)

[단계 2] 기존:  🔵 🔵 ❌ (하나 종료)
         새버전: 🟢

[단계 3] 기존:  🔵 ❌ ❌
         새버전: 🟢 🟢

[단계 4] 기존:  ❌ ❌ ❌
         새버전: 🟢 🟢 🟢 (완료)

```

**최댓값 설정:**

- 최댓값 200% = 기존 3개 + 새 3개 = 총 6개까지 동시 실행 가능

**장점:**

- 간단하고 안전함
- 서비스 중단 없음

**단점:**

- 사용자가 구버전/신버전 혼용 경험 가능
- 업데이트 시간이 다소 길 수 있음

### 블루그린 배포

**새 버전을 완전히 준비한 후 한 번에 교체**하는 방식

```
[파란색 환경] 🔵 🔵 🔵 (기존 버전)
              ↑
         모든 트래픽

[준비 단계]
[파란색] 🔵 🔵 🔵 (기존)
[초록색] 🟢 🟢 🟢 (신규 - 준비 중)

[전환 단계]
[파란색] 🔵 🔵 🔵 (대기)
         ↓
[초록색] 🟢 🟢 🟢 (신규)
         ↑
    모든 트래픽 (전환 완료!)

```

**장점:**

- 한 번에 모든 사용자가 새 버전 사용
- 문제 생기면 빠르게 롤백 가능

**단점:**

- 두 배의 리소스 필요 (비용 증가)
- 설정이 복잡함

**선택 가이드:**

- 간단한 업데이트 → 롤링 업데이트
- 중요한 변경사항 → 블루그린

---

## 5단계: Service Connect

여러 서비스가 있을 때, **서비스끼리 통신**할 수 있게 이름을 지어주는 기능입니다.

```
[서비스 A: 프론트엔드]
        ↓ 요청
[서비스 B: 백엔드] ← 이름이 있어야 찾을 수 있음!

```

**옵션:**

1. **클라이언트**: 다른 서비스에만 연결 (요청만 보냄)
2. **클라이언트 및 서버**: 다른 서비스도 나를 찾을 수 있음 (양방향)

**지금은**: 나중에 필요할 때 설정 (일단 넘어가기)

---

## 6단계: 네트워킹 설정

### VPC란?

**VPC (Virtual Private Cloud)** = 가상 네트워크

AWS 클라우드 안에 **내 전용 네트워크 공간**을 만드는 것입니다.

```
[AWS 클라우드]
  └─ [내 VPC]
       ├─ 서비스들
       ├─ 컴퓨터들
       └─ 데이터베이스들

```

**비유:**

- VPC = 아파트 단지
- Subnet = 동별 구분
- 보안 그룹 = 출입 통제 시스템

### Subnet 이해하기

**Subnet** = VPC 안에서 서비스를 보관하는 폴더 같은 것

```
[VPC - 아파트 단지]
  ├─ [Public Subnet - 101동]
  │    ├─ 로드 밸런서 (외부 접근 가능)
  │    └─ 웹 서버
  │
  └─ [Private Subnet - 102동]
       ├─ 데이터베이스 (외부 접근 불가)
       └─ 내부 API 서버

```

**Public Subnet**: 인터넷에서 접근 가능
**Private Subnet**: 내부에서만 접근 가능

**Docker와 비교:**

- Docker Network와 비슷한 개념
- 같은 Subnet 안의 컴퓨터들은 쉽게 통신 가능

### Public IP 할당

**퍼블릭 IP 주소** = 인터넷에서 접근 가능한 주소

```
✅ 퍼블릭 IP 있음
[태스크] ← 외부와 통신 가능
   ↕️
인터넷 (Docker Hub에서 이미지 다운로드 가능)

❌ 퍼블릭 IP 없음
[태스크] ← 외부와 통신 불가
   X
인터넷

```

**Fargate 사용 시:**

- 반드시 체크! (안 하면 이미지 다운로드 안 됨)

**⚠️ 주의사항:**

- 퍼블릭 IPv4 주소는 월 $4 정도 비용 발생
- AWS의 최근 정책 변경으로 IPv4 주소 사용 시 과금

**무료 대안:**

- IPv6 사용 (하지만 AWS에서 지원이 제한적)
- ECR(AWS의 Docker 이미지 저장소) + VPC 엔드포인트 사용

---

## 7단계: 로드 밸런서 설정

### 로드 밸런서가 필요한 이유

**로드 밸런서** = 들어오는 트래픽을 여러 태스크에 **균등하게 분배**하는 프로그램

```
[사용자들]
   ↓ ↓ ↓
[로드 밸런서] ← 단일 진입점
   ↓ ↓ ↓
[태스크1] [태스크2] [태스크3]

```

**필요한 이유:**

1. **Fargate의 경우**: 실제 서버가 없어서 외부에서 접속하려면 필수
2. **트래픽 분산**: 여러 태스크에 고르게 요청 분배
3. **헬스 체크**: 죽은 태스크로는 트래픽 보내지 않음
4. **고정 주소**: 태스크 IP가 바뀌어도 로드 밸런서 주소는 고정

**비유:**

- 로드 밸런서 = 호텔 프런트 데스크
- 태스크들 = 각 객실
- 손님(사용자)은 프런트로만 가면 빈 방(태스크)으로 안내받음

### Application Load Balancer 생성

```
[Application Load Balancer 설정]

1. 리스너 포트: 80 (HTTP)
   └─ 어떤 포트로 트래픽을 받을지

2. 대상 그룹: 자동 생성
   └─ 트래픽을 어디로 보낼지 (우리 서비스로!)

3. 프로토콜: HTTP
   └─ 나중에 HTTPS 추가 가능

```

**비용:** 로드 밸런서는 별도 요금 발생 (시간당 과금)

**대안:**

- Nginx를 직접 설치한 EC2 사용
- Traefik 같은 클라우드 친화적 도구 사용

---

## 8단계: 보안 그룹 설정

### 보안 그룹이란?

**보안 그룹 (Security Group)** = 방화벽 규칙

**누가 내 서비스에 접속할 수 있는지** 정의합니다.

```
[인터넷의 누군가]
        ↓
   [보안 그룹]  ← 허용/차단 결정
        ↓
   [내 서비스]

```

**비유:**

- 보안 그룹 = 아파트 경비실
- 규칙 = 방문자 명단
- 허용된 사람만 출입 가능

### 규칙 설정하기

**이상적인 구조:**

```
[로드 밸런서 보안 그룹]
규칙: 모든 IP에서 80번 포트 접속 허용
      ↓
[서비스 보안 그룹]
규칙: 로드 밸런서에서만 접속 허용

```

**VPC 메뉴에서 설정:**

```
유형: 사용자 지정 TCP
포트: 80
소스: 0.0.0.0/0 (모든 IP 허용)

```

**설명:**

- `0.0.0.0/0` = 전 세계 모든 IP 주소
- 80번 포트 = HTTP 기본 포트

**⚠️ 주의:**
로드 밸런서를 서비스와 함께 만들면 보안 그룹이 합쳐집니다.
더 안전하게 하려면 로드 밸런서를 별도로 만들어 각각 보안 그룹 설정하세요.

---

## 9단계: 서비스 생성 및 확인

### 생성 진행

1. **서비스 생성** 버튼 클릭
2. 로드 밸런서 생성 때문에 **5분 이상** 소요
3. 기다리면 서비스 생성 완료!

### 상태 확인

**서비스 페이지:**

```
서비스 상태: 활성
실행 중인 태스크: 3/3

```

**태스크 상태:**

- 🟢 **실행 중**: 정상 작동
- 🔵 **대기 중** (5분 이상): 문제 발생!

### 접속 테스트

1. **로드 밸런서 찾기**
   - EC2 → 로드 밸런서 메뉴
   - DNS 이름 복사
2. **브라우저 접속**

   ```
   http://로드밸런서DNS주소

   ```

3. **성공!**
   - Nginx와 웹서버가 표시되면 성공

### 다음 단계

실제 서비스로 운영하려면:

- ✅ 도메인 구매 및 연결
- ✅ HTTPS 인증서 설치 (AWS Certificate Manager)
- ✅ Route 53으로 DNS 설정

---

## 🔧 문제 해결 가이드

### 문제 1: 태스크가 5분 이상 "대기 중"

**증상:**

```
태스크 상태: 대기 중 (파란색)

```

**원인 및 해결:**

1. **이미지 다운로드 실패**
   - 에러: `CannotPullContainerError`
   - 해결: Public IP 할당 체크 확인
   - 또는: ECR에 이미지 업로드 후 사용
2. **잘못된 이미지 설정**
   - 태스크 정의에서 이미지 경로 확인
   - 이미지가 실제로 존재하는지 확인
3. **로그 확인**
   - 태스크 → 로그 탭
   - CloudWatch 로그에서 에러 메시지 확인

### 문제 2: 서비스는 실행 중인데 접속 안 됨

**증상:**

```
태스크: 실행 중 (초록색)
브라우저: 연결 불가

```

**원인 및 해결:**

1. **보안 그룹 설정 누락**
   - 로드 밸런서 보안 그룹 확인
   - 80번 포트가 0.0.0.0/0에 열려있는지 확인
2. **대상 그룹 설정 오류**
   - EC2 → 대상 그룹
   - 등록된 대상이 healthy 상태인지 확인
3. **Nginx 설정 오류**
   - 태스크 정의의 Nginx 설정 파일 확인
   - 로그에서 Nginx 에러 확인

### 문제 3: 비용이 예상보다 많이 나옴

**확인 사항:**

1. **실행 중인 리소스**
   - 서비스 (Fargate 작업 시간)
   - 로드 밸런서 (시간당)
   - Elastic IP (사용 중인 퍼블릭 IP)
   - NAT Gateway (사용 시)
2. **로그 확인**
   - EC2 → 로드 밸런서 (삭제 확인)
   - VPC → Elastic IP (릴리스 확인)
   - ECS → 서비스 (삭제 확인)

---

## 💰 비용 관리

### 리소스 정리 체크리스트

실습 후 반드시 삭제해야 할 것들:

```
✅ 1. ECS 서비스 삭제
   - ECS → 클러스터 → 서비스 → 삭제

✅ 2. 로드 밸런서 삭제
   - EC2 → 로드 밸런서 → 삭제
   - 대상 그룹도 함께 삭제됨

✅ 3. Elastic IP 릴리스
   - EC2 → Elastic IP → 릴리스
   - 안 쓰는 IP도 비용 발생!

✅ 4. NAT Gateway 삭제 (사용 시)
   - VPC → NAT Gateway → 삭제

✅ 5. CloudWatch 로그 (선택)
   - 로그 그룹 삭제 (무료 한도 초과 시)

```

**Fargate 클러스터:**

- 비어있으면 비용 없음
- 삭제해도 되고 안 해도 됨

### 예상 비용

**월간 비용 예시 (서울 리전):**

```
Fargate 작업 (1 vCPU, 2GB)
 - 시간당 약 $0.05
 - 하루 종일: $1.2
 - 한 달: $36

로드 밸런서
 - 시간당 $0.025
 - 한 달: $18

퍼블릭 IPv4
 - 개당 월 $3.6

총계: 약 $57/월 (1개 태스크 기준)

```

---

## 🎓 핵심 요약

### 주요 개념

1. **서비스 = 태스크들의 관리자**
   - 자동 재시작, 스케일링, 로드 밸런싱
2. **Fargate vs EC2**
   - Fargate: 관리 간편, 초보자 추천
   - EC2: 유연함, 고급 사용자용
3. **배포 방식**
   - 롤링: 점진적 교체
   - 블루그린: 한 번에 전환
4. **네트워킹**
   - VPC: 가상 네트워크
   - Subnet: 서비스를 담는 폴더
   - 보안 그룹: 접근 제어 규칙
5. **로드 밸런서**
   - 트래픽 분산
   - Fargate 필수
   - 별도 비용 발생

### 실무 팁

**✅ DO (권장):**

- Public IP 할당 (Fargate 사용 시)
- 보안 그룹 최소 권한 원칙
- 로드 밸런서 헬스 체크 설정
- 로그 모니터링 설정
- 실습 후 리소스 정리

**❌ DON'T (비권장):**

- 보안 그룹에 불필요한 포트 열기
- Elastic IP 방치 (비용 발생)
- 프로덕션에서 스팟 인스턴스만 사용
- 로그 없이 운영
- 비용 알림 설정 안 함

### 다음 학습 방향

1. **자동 스케일링 설정**
   - CPU/메모리 기반 자동 확장
2. **CI/CD 파이프라인 구축**
   - GitHub Actions + ECS 자동 배포
3. **모니터링 강화**
   - CloudWatch Alarms
   - Container Insights
4. **HTTPS 적용**
   - ACM 인증서 발급
   - Route 53 도메인 연결
5. **비용 최적화**
   - Savings Plans
   - Spot 인스턴스 활용

---

## 📝 연습 문제

### 기초 문제

1. Fargate와 EC2의 가장 큰 차이점은?
2. 롤링 업데이트와 블루그린 배포의 장단점은?
3. Public Subnet과 Private Subnet의 차이는?

### 중급 문제

1. 태스크가 계속 "대기 중" 상태일 때 가장 먼저 확인해야 할 것은?
2. 보안 그룹에서 `0.0.0.0/0`의 의미는?
3. 로드 밸런서가 없어도 서비스를 운영할 수 있는 경우는?

### 실습 문제

1. 태스크 개수를 1개에서 3개로 늘려보세요
2. 새로운 버전의 이미지로 롤링 업데이트 해보세요
3. 보안 그룹을 수정하여 특정 IP만 접속 가능하게 해보세요

---

## 🔗 참고 자료

- [AWS ECS 공식 문서](https://docs.aws.amazon.com/ecs/)
- [Fargate 요금 계산기](https://aws.amazon.com/fargate/pricing/)
- [ECS 모범 사례](https://docs.aws.amazon.com/AmazonECS/latest/bestpracticesguide/)
- [보안 그룹 규칙 설정 가이드](https://docs.aws.amazon.com/vpc/latest/userguide/VPC_SecurityGroups.html)

---

**마지막 체크:** 실습을 마쳤다면 모든 리소스를 삭제했는지 꼭 확인하세요! 💸

---
