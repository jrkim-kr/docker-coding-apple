# 8. Network 1. nginx 만들기

# 핵심 정리

## 🎯 학습 목표

이 튜토리얼을 마치면 다음을 할 수 있습니다:

- Nginx 리버스 프록시의 개념과 필요성 이해
- Docker 이미지로 Nginx 설정 및 실행
- 여러 컨테이너를 동시에 실행
- 컨테이너 간 통신의 기본 원리 파악

---

## 📚 사전 지식

- Docker 기본 명령어 (build, run)
- 포트(Port)의 개념
- 간단한 웹서버 경험

---

## 1단계: 리버스 프록시란?

### 리버스 프록시가 뭔가요?

웹서버 앞에 배치되어 들어오는 요청을 가로채서 전달하는 중간 프로그램입니다.

```
[사용자] → [리버스 프록시] → [웹서버]

```

### 왜 사용하나요?

비효율적으로 보이지만, 실제로는 많은 장점이 있습니다:

- ✅ **보안**: 실제 서버의 정체를 숨김
- ✅ **HTTPS**: SSL 인증서 설치가 쉬워짐
- ✅ **로드 밸런싱**: 여러 서버에 트래픽 분산
- ✅ **로깅**: 접속 기록 관리 용이
- ✅ **접근 제어**: IP 차단 등이 쉬움

---

## 2단계: Nginx 설정 파일 작성

### 프로젝트 폴더 만들기

```bash
mkdir nginx-practice
cd nginx-practice

```

### myconfig1.conf 파일 생성

```
server {
    listen 80;
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

```

### 설정 파일 이해하기

- **`listen 80`**: 80번 포트로 들어오는 요청을 처리
- **`location /`**: 모든 경로(/)에 대해 아래 규칙 적용
- **`proxy_pass`**: 요청을 localhost:8080으로 전달
- **`proxy_set_header`**: 요청 헤더에 클라이언트 정보 추가

---

## 3단계: Dockerfile 작성

같은 폴더에 `Dockerfile` 생성:

```docker
FROM nginx:latest

COPY ./myconfig1.conf /etc/nginx/conf.d/myconfig1.conf
RUN rm /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

```

### 각 줄 설명

- **FROM**: Nginx 공식 이미지를 베이스로 사용
- **COPY**: 우리가 만든 설정 파일을 컨테이너 안으로 복사
- **RUN**: 기본 설정 파일 삭제 (충돌 방지)
- **EXPOSE**: 80번 포트 사용을 명시
- **CMD**: Nginx를 포어그라운드로 실행

---

## 4단계: 이미지 빌드 및 실행

### 이미지 빌드

```bash
docker build -t nginx:1 .

```

### 컨테이너 실행

```bash
docker run -d -p 80:80 --name my-nginx nginx:1

```

### 확인하기

브라우저에서 `http://localhost:80` 접속
→ 에러 페이지가 나오면 **성공**! (아직 8080에 서버가 없어서 에러)

---

## 5단계: 웹서버 컨테이너 추가

### 웹서버 실행

이전에 만든 웹서버 이미지가 있다면:

```bash
docker run -d -p 8080:8080 --name my-webserver [웹서버이미지명]

```

### 다시 확인

브라우저에서 `http://localhost:80` 접속
→ 여전히 안 됩니다! 왜일까요?

---

## 🤔 문제 상황 이해하기

### 현재 구조

```
[내 컴퓨터]
    ↓ 포트 80
[Nginx 컨테이너] ← "localhost:8080으로 보내라!"
    ↓ ???
    X (8080 포트에 아무것도 없음)

[내 컴퓨터]
    ↓ 포트 8080
[웹서버 컨테이너] ← 여기에 웹서버가 있지만...

```

### 문제점

각 컨테이너는 독립된 가상 컴퓨터이고, Nginx 컨테이너 내부의 localhost:8080은 해당 컨테이너 자신을 가리킵니다. 다른 컨테이너에는 접근할 수 없습니다.

---

## 6단계: 해결 방법 (예고편)

### 방법 1: 호스트를 경유하는 방법

```
proxy_pass http://host.docker.internal:8080;

```

컨테이너에서 내 컴퓨터를 거쳐 다른 컨테이너로 접근

### 방법 2: Docker Network 사용 (권장)

```bash
# 네트워크 생성
docker network create my-network

# 컨테이너들을 같은 네트워크에 연결
docker run --network my-network ...

```

같은 네트워크 안의 컨테이너들은 서로 가상 IP 주소를 부여받아 쉽게 통신할 수 있습니다.

---

## 🎓 핵심 요약

1. **리버스 프록시**는 서버 앞단에서 요청을 중개하는 프로그램
2. **Nginx**는 설정 파일(.conf)로 동작 방식을 제어
3. **각 컨테이너**는 독립된 가상 환경 (서로 격리됨)
4. **컨테이너 간 통신**을 위해서는 네트워크 설정이 필요

---

## 🔍 다음 단계

다음 튜토리얼에서는:

- Docker Network를 실제로 만들어보기
- 컨테이너를 네트워크에 연결하기
- Nginx와 웹서버를 실제로 연동하기

---

## 💡 연습 문제

1. Nginx 설정에서 `listen` 포트를 8888로 변경하고 재빌드해보세요
2. `proxy_pass` 주소를 다른 포트로 바꿔보세요
3. 실행 중인 모든 컨테이너 목록을 확인하는 명령어는? (`docker ps`)
