# 8. Network 1. nginx 만들기

## 📑 목차

### 📘 핵심 정리 섹션
1. [학습 목표](#-학습-목표)
2. [사전 지식](#-사전-지식)
3. [1단계: 리버스 프록시란?](#1단계-리버스-프록시란)
   - [리버스 프록시가 뭔가요?](#리버스-프록시가-뭔가요)
   - [왜 사용하나요?](#왜-사용하나요)
4. [2단계: Nginx 설정 파일 작성](#2단계-nginx-설정-파일-작성)
   - [프로젝트 폴더 만들기](#프로젝트-폴더-만들기)
   - [myconfig1conf 파일 생성](#myconfig1conf-파일-생성)
   - [설정 파일 이해하기](#설정-파일-이해하기)
5. [3단계: Dockerfile 작성](#3단계-dockerfile-작성)
   - [각 줄 설명](#각-줄-설명)
6. [4단계: 이미지 빌드 및 실행](#4단계-이미지-빌드-및-실행)
   - [이미지 빌드](#이미지-빌드)
   - [컨테이너 실행](#컨테이너-실행)
   - [확인하기](#확인하기)
7. [5단계: 웹서버 컨테이너 추가](#5단계-웹서버-컨테이너-추가)
   - [웹서버 실행](#웹서버-실행)
   - [다시 확인](#다시-확인)
8. [문제 상황 이해하기](#-문제-상황-이해하기)
   - [현재 구조](#현재-구조)
   - [문제점](#문제점)
9. [6단계: 해결 방법 (예고편)](#6단계-해결-방법-예고편)
   - [방법 1: 호스트를 경유하는 방법](#방법-1-호스트를-경유하는-방법)
   - [방법 2: Docker Network 사용 (권장)](#방법-2-docker-network-사용-권장)
10. [핵심 요약](#-핵심-요약)
11. [다음 단계](#-다음-단계)
12. [연습 문제](#-연습-문제)

### 📝 강의 스크립트 섹션
13. [강의 도입](#강의-도입)
14. [Nginx 소개](#nginx-소개)
    - [Reverse Proxy란?](#reverse-proxy란)
    - [리버스 프록시를 사용하는 이유](#리버스-프록시를-사용하는-이유)
15. [Nginx 설치 및 실행 방법](#nginx-설치-및-실행-방법)
16. [conf 파일 사용법](#conf-파일-사용법)
    - [설정 파일 작성](#설정-파일-작성)
    - [설정 파일 배치 위치](#설정-파일-배치-위치)
    - [기본 설정 파일 처리](#기본-설정-파일-처리)
17. [이미지 빌드하기](#이미지-빌드하기)
    - [Dockerfile 작성](#dockerfile-작성)
    - [이미지 빌드 실행](#이미지-빌드-실행)
    - [컨테이너 실행 및 테스트](#컨테이너-실행-및-테스트)
18. [컨테이너 간 통신 문제](#컨테이너-간-통신-문제)
    - [문제 발생 상황](#문제-발생-상황)
    - [문제 원인 분석](#문제-원인-분석)
19. [다른 가상컴퓨터로 접속하는 방법](#다른-가상컴퓨터로-접속하는-방법)
    - [호스트 경유 방법](#호스트-경유-방법)
    - [Docker Network 사용 (예고)](#docker-network-사용-예고)

---

# 핵심 정리

## 🎯 학습 목표

이 튜토리얼을 마치면 다음을 할 수 있습니다:

- Nginx 리버스 프록시의 개념과 필요성 이해
- Docker 이미지로 Nginx 설정 및 실행
- 여러 컨테이너를 동시에 실행
- 컨테이너 간 통신의 기본 원리 파악

---

## 📚 사전 지식

- Docker 기본 명령어 (build, run)
- 포트(Port)의 개념
- 간단한 웹서버 경험

---

## 1단계: 리버스 프록시란?

### 리버스 프록시가 뭔가요?

웹서버 앞에 배치되어 들어오는 요청을 가로채서 전달하는 중간 프로그램입니다.

```
[사용자] → [리버스 프록시] → [웹서버]

```

### 왜 사용하나요?

비효율적으로 보이지만, 실제로는 많은 장점이 있습니다:

- ✅ **보안**: 실제 서버의 정체를 숨김
- ✅ **HTTPS**: SSL 인증서 설치가 쉬워짐
- ✅ **로드 밸런싱**: 여러 서버에 트래픽 분산
- ✅ **로깅**: 접속 기록 관리 용이
- ✅ **접근 제어**: IP 차단 등이 쉬움

---

## 2단계: Nginx 설정 파일 작성

### 프로젝트 폴더 만들기

```bash
mkdir nginx-practice
cd nginx-practice

```

### myconfig1.conf 파일 생성

```
server {
    listen 80;
    location / {
        proxy_pass http://localhost:8080;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}

```

### 설정 파일 이해하기

- **`listen 80`**: 80번 포트로 들어오는 요청을 처리
- **`location /`**: 모든 경로(/)에 대해 아래 규칙 적용
- **`proxy_pass`**: 요청을 localhost:8080으로 전달
- **`proxy_set_header`**: 요청 헤더에 클라이언트 정보 추가

---

## 3단계: Dockerfile 작성

같은 폴더에 `Dockerfile` 생성:

```docker
FROM nginx:latest

COPY ./myconfig1.conf /etc/nginx/conf.d/myconfig1.conf
RUN rm /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]

```

### 각 줄 설명

- **FROM**: Nginx 공식 이미지를 베이스로 사용
- **COPY**: 우리가 만든 설정 파일을 컨테이너 안으로 복사
- **RUN**: 기본 설정 파일 삭제 (충돌 방지)
- **EXPOSE**: 80번 포트 사용을 명시
- **CMD**: Nginx를 포어그라운드로 실행

---

## 4단계: 이미지 빌드 및 실행

### 이미지 빌드

```bash
docker build -t nginx:1 .

```

### 컨테이너 실행

```bash
docker run -d -p 80:80 --name my-nginx nginx:1

```

### 확인하기

브라우저에서 `http://localhost:80` 접속
→ 에러 페이지가 나오면 **성공**! (아직 8080에 서버가 없어서 에러)

---

## 5단계: 웹서버 컨테이너 추가

### 웹서버 실행

이전에 만든 웹서버 이미지가 있다면:

```bash
docker run -d -p 8080:8080 --name my-webserver [웹서버이미지명]

```

### 다시 확인

브라우저에서 `http://localhost:80` 접속
→ 여전히 안 됩니다! 왜일까요?

---

## 🤔 문제 상황 이해하기

### 현재 구조

```
[내 컴퓨터]
    ↓ 포트 80
[Nginx 컨테이너] ← "localhost:8080으로 보내라!"
    ↓ ???
    X (8080 포트에 아무것도 없음)

[내 컴퓨터]
    ↓ 포트 8080
[웹서버 컨테이너] ← 여기에 웹서버가 있지만...

```

### 문제점

각 컨테이너는 독립된 가상 컴퓨터이고, Nginx 컨테이너 내부의 localhost:8080은 해당 컨테이너 자신을 가리킵니다. 다른 컨테이너에는 접근할 수 없습니다.

---

## 6단계: 해결 방법 (예고편)

### 방법 1: 호스트를 경유하는 방법

```
proxy_pass http://host.docker.internal:8080;

```

컨테이너에서 내 컴퓨터를 거쳐 다른 컨테이너로 접근

### 방법 2: Docker Network 사용 (권장)

```bash
# 네트워크 생성
docker network create my-network

# 컨테이너들을 같은 네트워크에 연결
docker run --network my-network ...

```

같은 네트워크 안의 컨테이너들은 서로 가상 IP 주소를 부여받아 쉽게 통신할 수 있습니다.

---

## 🎓 핵심 요약

1. **리버스 프록시**는 서버 앞단에서 요청을 중개하는 프로그램
2. **Nginx**는 설정 파일(.conf)로 동작 방식을 제어
3. **각 컨테이너**는 독립된 가상 환경 (서로 격리됨)
4. **컨테이너 간 통신**을 위해서는 네트워크 설정이 필요

---

## 🔍 다음 단계

다음 튜토리얼에서는:

- Docker Network를 실제로 만들어보기
- 컨테이너를 네트워크에 연결하기
- Nginx와 웹서버를 실제로 연동하기

---

## 💡 연습 문제

1. Nginx 설정에서 `listen` 포트를 8888로 변경하고 재빌드해보세요
2. `proxy_pass` 주소를 다른 포트로 바꿔보세요
3. 실행 중인 모든 컨테이너 목록을 확인하는 명령어는? (`docker ps`)

# 강의 스크립트

실은 컨테이너를 동시에 여러개 띄울 수 있습니다.

그럼 각각 컨테이너 안에 들어있는 프로그램들 간에 통신은 어떻게 하게요?

그래서 오늘은 컨테이너끼리 통신하는 방법을 알아볼 것인데

그냥 하면 재미없으니 nginx라는 프로그램을 먼저 만들어서 돌려봅시다.

> nginx

웹서버와 함께 돌리면 매우 좋은 프로그램이 하나 있습니다.

reverse proxy라고 하는데 서버로 들어오는 요청을 중간에 가로채주는 간단한 프로그램입니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EC%A0%9C%EB%AA%A9-%EC%97%86%EC%9D%8C-1.png)

▲ 그걸 쓰면 유저들이 서버로 직접 들어오게 하는게 아니라

리버스 프록시 프로그램으로 먼저 들어오게 하고

리버스 프록시가 유저를 다시 서버로 안내하는 식으로 만들어놓습니다.

왜 그따구로 비효율적인 프로그램을 띄워놓냐면

- 서버의 정체를 안전하게 숨기기 가능
- HTTPS 인증서 설치 쉬움
- 서버가 여러개면 로드 밸런싱 가능
- 누가 접속했는지 로그도 남기기 쉬움
- IP 차단 쉽게가능

그래서 사용합니다.

nginx 아니면 caddy 이런게 유명한데 우리는 nginx라는 리버스 프록시 프로그램을 써보도록 합시다.

> nginx

이것도 이미지 만들어서 컨테이너로 실행해볼 것인데

그럴려면 nginx를 로컬컴퓨터에서 설치하고 셋팅하는 방법도 아는게 좋겟죠?

그래야 Dockerfile을 작성하든 할 것 아닙니까

여러분들 컴퓨터에서 nginx 설치하고 실행하려면

1. 컴퓨터에 nginx 설치

2. 동작방식을 .conf 파일에 맘대로 작성해서 설치폴더에 집어넣어두고

3. 터미널에 nginx -g daemon off; 입력해두면 nginx가 실행됩니다.

우선 .conf 파일은 어떻게 작성하는지 맛을 먼저 보도록 합시다.

> .conf 파일 사용법

```perl
(myconfig1.conf)

server {
        listen 80;
        location / {
            proxy_pass http://localhost:8080;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }
}
```

아무 폴더 하나 만들어서 어쩌구.conf 파일을 안에 만들고 위에 있는 대충 기본적인 설정들을 복붙해봅시다.

- listen 80은 누가 80번 포트로 들어오면 밑에 있는 내용을 실행하라는 뜻입니다.
- location / { } 부분은 누가 /로 시작하는 모든 경로로 들어오면 localhost:8080으로 보내라는 뜻입니다.
- proxy_set_header 부분은 header라는 부분에 IP 주소 등 여러 정보를 채우라는 뜻인데 심심해서 넣어봤습니다.

그리고 이 설정파일을 특정 폴더에 넣어줘야합니다.

리눅스에 nginx를 설치했으면 /etc/nginx/conf.d/ 폴더에 넣어주면

그러면 nginx가 알아서 .conf 파일을 가져가서 사용해줍니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EA%B7%B8%EB%A6%BC17.png)

정확히말하면 /etc/nginx/conf.d/어쩌구.conf 파일은

nginx.conf 라는 기본 설정파일의 http { } 안에 자동으로 넣어서 실행됩니다.

근데 사소한 문제가 있는게

/etc/nginx/conf.d/default.conf 이라는 파일이 자동으로 생성되어있는데

그게 여러분들이 작성한 설정보다 먼저 적용될 수가 있습니다.

그래서 기본설정은 쓸데없으니까 그 파일은 삭제하면 됩니다.

덮어써도 되고 삭제해도 됩니다.

> 이미지 빌드하기

그래서 dockerfile 이용해서 nginx 이미지를 한번 만들어보도록 합시다.

nginx 설치하고 설정하고 실행하는거 그대로 Dockerfile에 써놓고 빌드하면 되겠군요.

```objectivec
(Dockerfile)

FROM nginx:latest

COPY ./myconfig1.conf /etc/nginx/conf.d/myconfig1.conf
RUN rm /etc/nginx/conf.d/default.conf

EXPOSE 80
CMD ["nginx", "-g", "daemon off"]
```

- nginx 설치하고
- Dockerfile 옆에 만들어둔 myconfig1.conf 설정파일을 리눅스의 /etc/nginx/conf.d/에 복붙하고
- 기본설정파일은 삭제하고
- nginx 실행하라고 했습니다.

```
docker build -t nginx:1 .
```

터미널에서 nginx라는 이름으로 이미지를 빌드도 해봤습니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EA%B7%B8%EB%A6%BC78.png)

▲ 이미지 실행도 해봅시다.

누가 내 컴퓨터 80번 포트로 들어오면 이 컨테이너 80번 포트로 안내하라고 해봤습니다.

그럼 이제 localhost:80으로 접속해보면 뭔가 이상한게 나올텐데 그럼 성공입니다.

nginx 설정에다가 누가 80번포트로 접속하면 localhost:8080으로 안내하라고 코드짜놨으니까

그럼 이제 localhost:8080에 웹서버를 띄워놓으면 의도대로 리버스 프록시처럼 잘 동작하지 않을까요?

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EA%B7%B8%EB%A6%BC79.png)

▲ 그래서 전에 만든 **웹서버**도 8080포트에 컨테이너로 띄워봤습니다.

그럼 이론상 localhost:80 접속하면 localhost:8080에 있는 서버가 떠야하는데

아무것도 안뜨는데요?

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EA%B7%B8%EB%A6%BC1551.png)

▲ 그 이유는 그림으로 보시면 지금 가상컴퓨터 2대를 띄워놨고

내 컴퓨터의 포트도 거기에 각각 연결해뒀습니다.

왼쪽 nginx 가상컴퓨터에는 "누가 80번 포트로 들어오면 8080포트로 보내기" 라고 코드를 짜놨습니다.

하지만 왼쪽 nginx 가상컴퓨터에는 8080포트에서 동작중인 프로그램이 없는데요?

그래서 내 컴퓨터 80번 포트인 localhost:80으로 들어가도 아무것도 안나오고 에러가 나는 것일 뿐입니다.

**Q. 오른쪽 가상컴퓨터에 8080포트에 웹서버 돌아가고 있는데요?**

- 그건 nginx와 상관없는 다른 별도의 컴퓨터일 뿐입니다.

그래서 누가 "80번 포트로 들어오면 옆에 있는 가상 컴퓨터의 8080번 포트로 보내기" 이렇게 코드를 짜면 잘 동작합니다.

그럼 다른 가상컴퓨터로 접속하는 법을 알면 되겠네요.

> 다른 가상컴퓨터로 접속하려면

어떤 가상컴퓨터에서 다른 가상컴퓨터로 접속하려면 이런 방법도 있습니다.

내 컴퓨터랑 가상컴퓨터랑 포트를 연결해놨기 때문에

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EA%B7%B8%EB%A6%BC16.png)

▲ "누가 80번 포트로 접속하면 다시 올라가서 내 컴퓨터의 8080번 포트로 들어가라"

이렇게 역류하는 식으로 짜도 되긴 합니다.

![](https://d2hxk0kgvzehcg.cloudfront.net/wp-content/uploads/2024/11/%EA%B7%B8%EB%A6%BC12-1.png)

▲ 근데 이것보다 더 안전하고 간단하게 하려면 network 라는걸 만들어서 그 안에 가상 컴퓨터를 담아놓아도 됩니다.

같은 network 안에 들어있는 가상 컴퓨터들은 서로 쉽게 통신이 가능해집니다.

왜냐면 network 안에 집어넣으면 가상 IP주소를 부여해주기 때문에

**가상IP주소:8080** 이런 식으로 사용하면 다른 가상컴퓨터에 접속가능합니다.

다음 시간에 해봅시다.
