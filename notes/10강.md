# 10. Volume 사용법과 PostgreSQL DB 띄우기

# 핵심 정리

## 🎯 학습 목표

이 튜토리얼을 마치면 다음을 할 수 있습니다:

- Docker Volume의 개념과 필요성 이해
- PostgreSQL DB를 컨테이너로 실행
- Volume을 생성하고 컨테이너에 장착
- 데이터를 영구적으로 보관하는 방법 습득
- Bind Mount와 Volume의 차이점 파악

---

## 📚 사전 지식

- Docker 기본 명령어 (run, exec)
- 컨테이너의 개념
- 간단한 터미널 명령어
- (선택) SQL 기본 문법

---

## 1단계: Volume이란?

### 왜 Volume이 필요한가요?

**문제 상황:**

```
[컨테이너 실행] → [데이터 저장] → [컨테이너 종료] → 💥 데이터 사라짐!

```

컨테이너는 기본적으로 **일회용**입니다. 컨테이너를 삭제하거나 재시작하면 안에 있던 모든 데이터가 초기화됩니다.

**해결책: Volume**

```
[컨테이너] ⇄ [Volume (영구 저장소)]
     ↓
컨테이너를 삭제해도 Volume에 데이터 보관됨

```

### Volume의 작동 원리

```
┌─────────────────┐
│   컨테이너      │
│  /var/lib/...   │ ← 데이터 생성
│        ↓        │
└────────┬────────┘
         │ 자동 복사
         ↓
┌─────────────────┐
│   Volume        │
│  (영구 저장)    │ ← 데이터 보존
└─────────────────┘

```

- **컨테이너에서 데이터 생성** → 자동으로 Volume에 복사
- **컨테이너 재시작** → Volume에서 데이터 불러옴
- **데이터 안전하게 보관** ✅

---

## 2단계: PostgreSQL 이미지 다운받기

### Docker Desktop에서 다운받기

1. Docker Desktop 실행
2. 상단 검색창에 `postgres` 입력
3. `postgres:17-alpine` 선택 (용량이 작은 버전)
4. Pull 버튼 클릭

### 터미널에서 다운받기

```bash
docker pull postgres:17-alpine

```

**Alpine이란?**

- 경량화된 리눅스 배포판
- 용량이 작아서 빠르게 다운로드 가능
- 기본 기능은 모두 포함

---

## 3단계: DB 컨테이너 실행하기

### 환경변수란?

프로그램 실행 시 필요한 설정값입니다. DB는 보안을 위해 아이디/비밀번호를 **환경변수**로 받습니다.

```
환경변수 = 프로그램의 초기 설정값

```

### Docker Desktop에서 실행

1. Images 탭에서 `postgres:17-alpine` 찾기
2. Run 버튼 클릭
3. Optional settings 펼치기
4. Environment variables 섹션에 추가:
   - `POSTGRES_USER`: `admin`
   - `POSTGRES_PASSWORD`: `qwer1234`
5. Container name: `db-container`
6. Run 버튼 클릭

### 실행 명령어 이해하기

터미널에서 실행하려면:

```bash
docker run -d --name db-container \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=qwer1234 \
  postgres:17-alpine

```

**각 옵션 설명:**

- `d`: 백그라운드로 실행 (detached mode)
- `-name db-container`: 컨테이너 이름 지정
- `e POSTGRES_USER=admin`: 환경변수 설정 (DB 유저명)
- `e POSTGRES_PASSWORD=qwer1234`: 환경변수 설정 (DB 비밀번호)

---

## 4단계: DB에 접속하기

### 컨테이너 터미널 접속

**방법 1: Docker Desktop 사용**

1. Containers 탭에서 `db-container` 찾기
2. 우측의 `Exec` 탭 클릭
3. 터미널 화면 나타남

**방법 2: 터미널 명령어**

```bash
docker exec -it db-container /bin/sh

```

- `exec`: 실행 중인 컨테이너에서 명령 실행
- `it`: 인터랙티브 터미널 모드
- `/bin/sh`: 쉘(터미널) 실행

### psql 사용법

컨테이너 터미널에 들어왔다면:

```bash
psql -U admin -W

```

- `psql`: PostgreSQL 터미널 클라이언트
- `U admin`: 유저명 지정
- `W`: 비밀번호 입력 프롬프트 표시

비밀번호 입력 후 접속 성공!

```
psql (17.0)
Type "help" for help.

admin=#

```

### 기본 psql 명령어

| 명령어 | 설명                   | 예시          |
| ------ | ---------------------- | ------------- |
| `\l`   | 데이터베이스 목록 보기 | `\l`          |
| `\c`   | 데이터베이스 접속      | `\c postgres` |
| `\d`   | 테이블 목록 보기       | `\d`          |
| `\dt`  | 테이블만 보기          | `\dt`         |
| `\q`   | psql 종료              | `\q`          |

**데이터베이스 vs 테이블:**

- **데이터베이스**: 테이블을 담는 폴더
- **테이블**: 실제 데이터가 저장되는 엑셀 시트

---

## 5단계: 데이터 생성 및 조회

### 데이터베이스 접속

```sql
\c postgres

```

기본으로 생성되는 `postgres` 데이터베이스에 접속합니다.

### 테이블 만들기

```sql
CREATE TABLE product (
    title VARCHAR(100)
);

```

- `CREATE TABLE`: 테이블 생성 명령
- `product`: 테이블 이름
- `title VARCHAR(100)`: 문자열 컬럼 (최대 100자)

**실행 결과:**

```
CREATE TABLE

```

### 데이터 추가하기

```sql
INSERT INTO product VALUES ('shirt');
INSERT INTO product VALUES ('pants');
INSERT INTO product VALUES ('shoes');

```

- `INSERT INTO`: 데이터 삽입 명령
- `VALUES`: 삽입할 값

**실행 결과:**

```
INSERT 0 1

```

### 데이터 조회하기

```sql
SELECT * FROM product;

```

**실행 결과:**

```
 title
-------
 shirt
 pants
 shoes
(3 rows)

```

---

## 6단계: Volume 생성 및 장착

### 문제 상황 재현

지금까지 만든 데이터는 컨테이너 안에만 있습니다:

```bash
# 컨테이너 정지 및 삭제
docker stop db-container
docker rm db-container

# 다시 실행
docker run -d --name db-container \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=qwer1234 \
  postgres:17-alpine

```

다시 접속해서 확인하면:

```sql
\c postgres
\d
# 테이블이 없음!

```

💥 **데이터가 모두 사라졌습니다!**

### Volume 만들기

**Docker Desktop에서:**

1. 좌측 메뉴에서 `Volumes` 클릭
2. `Create` 버튼 클릭
3. Volume name: `postgres-data`

**터미널에서:**

```bash
docker volume create postgres-data

```

### Volume 명령어 모음

```bash
# Volume 생성
docker volume create 볼륨이름

# Volume 목록 보기
docker volume ls

# Volume 상세 정보
docker volume inspect 볼륨이름

# Volume 삭제
docker volume rm 볼륨이름

```

### Volume과 함께 컨테이너 실행

```bash
docker run -d --name db-container \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=qwer1234 \
  -v postgres-data:/var/lib/postgresql/data \
  postgres:17-alpine

```

**새로운 옵션:**

- `v postgres-data:/var/lib/postgresql/data`
  - `postgres-data`: Volume 이름
  - `/var/lib/postgresql/data`: PostgreSQL이 데이터를 저장하는 컨테이너 내부 경로

**다른 DB의 데이터 경로:**

- MySQL: `/var/lib/mysql`
- MongoDB: `/data/db`
- Redis: `/data`

---

## 7단계: 데이터 영속성 확인

### 데이터 다시 생성

```bash
# 컨테이너 접속
docker exec -it db-container /bin/sh

# psql 접속
psql -U admin -W

```

```sql
-- 데이터베이스 접속
\c postgres

-- 테이블 생성
CREATE TABLE product (
    id SERIAL PRIMARY KEY,
    title VARCHAR(100),
    price INT
);

-- 데이터 추가
INSERT INTO product (title, price) VALUES ('shirt', 25000);
INSERT INTO product (title, price) VALUES ('pants', 35000);

-- 확인
SELECT * FROM product;

```

**실행 결과:**

```
 id | title | price
----+-------+-------
  1 | shirt | 25000
  2 | pants | 35000

```

### 컨테이너 삭제 후 재실행

```bash
# 컨테이너 정지 및 삭제
docker stop db-container
docker rm db-container

# 같은 Volume으로 다시 실행
docker run -d --name db-container \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=qwer1234 \
  -v postgres-data:/var/lib/postgresql/data \
  postgres:17-alpine

```

### 데이터 확인

```bash
docker exec -it db-container /bin/sh
psql -U admin -W

```

```sql
\c postgres
SELECT * FROM product;

```

**결과:**

```
 id | title | price
----+-------+-------
  1 | shirt | 25000
  2 | pants | 35000

```

✅ **데이터가 그대로 남아있습니다!**

---

## 8단계: Bind Mount 이해하기

### Volume vs Bind Mount

| 특징      | Volume               | Bind Mount       |
| --------- | -------------------- | ---------------- |
| 관리 주체 | Docker               | 사용자           |
| 저장 위치 | Docker 관리 폴더     | 내가 지정한 폴더 |
| 경로      | 자동 생성            | 직접 지정        |
| 사용 용도 | 일반적인 데이터 보관 | 개발/디버깅      |

### Bind Mount 사용법

```bash
docker run -d --name db-container \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=qwer1234 \
  -v /Users/myname/db-data:/var/lib/postgresql/data \
  postgres:17-alpine

```

- `/Users/myname/db-data`: 내 컴퓨터의 실제 폴더 경로
- 이 폴더에 DB 데이터가 직접 저장됨

### 언제 Bind Mount를 사용하나요?

**Volume 사용 (권장):**

- 운영 환경의 DB
- 자동 백업 시스템 구축
- Docker가 알아서 관리

**Bind Mount 사용:**

- 개발 중 코드 변경사항 즉시 반영
- 로그 파일 직접 확인
- 특정 위치에 데이터 보관 필요

---

## 🎓 핵심 요약

### Volume의 필요성

```
컨테이너 = 휘발성 (데이터 사라짐)
Volume = 영속성 (데이터 보존)

```

### 실습 순서 복습

1. **DB 이미지 다운** → `postgres:17-alpine`
2. **환경변수 설정** → 아이디/비밀번호
3. **컨테이너 실행** → DB 서버 시작
4. **psql 접속** → DB 조작
5. **Volume 생성** → 데이터 저장소
6. **Volume 장착** → `v` 옵션 사용
7. **영속성 확인** → 컨테이너 삭제 후 재실행

### 핵심 명령어

```bash
# Volume 생성
docker volume create postgres-data

# Volume과 함께 실행
docker run -v postgres-data:/var/lib/postgresql/data postgres:17-alpine

# 컨테이너 터미널 접속
docker exec -it 컨테이너명 /bin/sh

# DB 접속
psql -U admin -W

```

---

## 💡 실전 팁

### 1. Volume 백업하기

Volume 내용을 압축 파일로 백업:

```bash
docker run --rm -v postgres-data:/data -v $(pwd):/backup \
  alpine tar czf /backup/backup.tar.gz -C /data .

```

### 2. Volume 복원하기

백업 파일에서 Volume 복원:

```bash
docker run --rm -v postgres-data:/data -v $(pwd):/backup \
  alpine tar xzf /backup/backup.tar.gz -C /data

```

### 3. 실제 프로덕션 환경에서는?

**컨테이너 DB의 장단점:**

**장점:**

- ✅ 빠른 환경 구축
- ✅ 테스트/개발 환경 구축 용이
- ✅ 버전 관리 쉬움

**단점:**

- ⚠️ 안정성 문제
- ⚠️ 백업 관리 복잡
- ⚠️ 성능 오버헤드

**권장 사항:**

- **개발/테스트**: 컨테이너 DB 사용
- **운영 환경**: 관리형 DB 서비스 사용 (AWS RDS, Google Cloud SQL 등)

### 4. Node.js에서 PostgreSQL 연결

```jsx
const { Pool } = require("pg");

const pool = new Pool({
  host: "localhost", // 또는 컨테이너 이름
  database: "postgres",
  user: "admin",
  password: "qwer1234",
  port: 5432,
});

// 쿼리 실행
app.get("/products", async (req, res) => {
  try {
    const result = await pool.query("SELECT * FROM product");
    res.json(result.rows);
  } catch (err) {
    console.error(err);
    res.status(500).send("Database error");
  }
});
```

---

## 💪 연습 문제

### 기초 문제

1. **Volume 생성하기**
   - `my-test-volume`이라는 이름의 Volume을 생성하세요
2. **DB 컨테이너 실행**
   - PostgreSQL을 Volume과 함께 실행하세요
   - 포트를 5432:5432로 매핑하세요
3. **테이블 생성 및 데이터 입력**
   - `users` 테이블을 만드세요 (id, name, email)
   - 3명의 사용자 데이터를 추가하세요

### 심화 문제

1. **영속성 테스트**
   - 컨테이너를 삭제하고 다시 실행
   - 데이터가 유지되는지 확인
2. **Bind Mount 실습**
   - 내 컴퓨터의 특정 폴더를 Bind Mount로 연결
   - 해당 폴더에 DB 파일이 생성되는지 확인
3. **여러 테이블 만들기**
   - `orders` 테이블 생성 (order_id, user_id, product_id, quantity)
   - `users`와 `orders`를 JOIN하는 쿼리 작성

### 정답 예시

**문제 1-3 정답:**

```bash
# 1. Volume 생성
docker volume create my-test-volume

# 2. 컨테이너 실행
docker run -d --name my-postgres \
  -e POSTGRES_USER=admin \
  -e POSTGRES_PASSWORD=qwer1234 \
  -p 5432:5432 \
  -v my-test-volume:/var/lib/postgresql/data \
  postgres:17-alpine

# 3. 접속 및 테이블 생성
docker exec -it my-postgres /bin/sh
psql -U admin -W

```

```sql
-- 데이터베이스 접속
\c postgres

-- 테이블 생성
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100),
    email VARCHAR(100)
);

-- 데이터 입력
INSERT INTO users (name, email) VALUES
    ('김철수', 'kim@example.com'),
    ('이영희', 'lee@example.com'),
    ('박민수', 'park@example.com');

-- 확인
SELECT * FROM users;

```

**문제 6 정답:**

```sql
-- orders 테이블 생성
CREATE TABLE orders (
    order_id SERIAL PRIMARY KEY,
    user_id INT,
    product_id INT,
    quantity INT
);

-- 샘플 데이터
INSERT INTO orders (user_id, product_id, quantity) VALUES
    (1, 101, 2),
    (2, 102, 1),
    (1, 103, 5);

-- JOIN 쿼리
SELECT u.name, u.email, o.order_id, o.quantity
FROM users u
JOIN orders o ON u.id = o.user_id;

```

---

## 📌 자주 묻는 질문 (FAQ)

**Q: Volume을 삭제하면 데이터도 사라지나요?**

- A: 네, Volume을 삭제하면 안에 있던 모든 데이터가 영구적으로 삭제됩니다. 주의하세요!

**Q: 하나의 Volume을 여러 컨테이너가 공유할 수 있나요?**

- A: 네, 가능합니다. 여러 컨테이너가 같은 Volume을 읽고 쓸 수 있습니다.

**Q: Volume의 실제 저장 위치는 어디인가요?**

- A: Docker Desktop의 경우 가상 머신 내부에 저장됩니다. `docker volume inspect` 명령으로 경로를 확인할 수 있습니다.

**Q: DB 컨테이너 포트를 외부에 노출하지 않아도 되나요?**

- A: 네, 같은 Docker Network 내에서만 통신한다면 포트 바인딩이 필요 없습니다. 보안상 더 안전합니다.
